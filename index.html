<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Bek Calc — ведомость работ</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f7f8fa; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --accent-weak:#eaf1ff; --danger:#ef4444; --success:#10b981;}
html,body{background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
*{box-sizing:border-box;}
header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid var(--line); padding:12px 16px;}
.brand{display:flex; align-items:center; gap:12px;}
.brand img{ width:48px; height:48px; border-radius:10px; border:1px solid var(--line); background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.06);}
.brand .name{ font-weight:800; font-size:20px; letter-spacing:.2px;}
.badge { display:inline-block; padding:4px 10px; border:1px solid var(--line); border-radius:999px; background:var(--accent-weak); font-size:12px; }
main{max-width:1200px; margin:16px auto; padding:0 14px;}
.card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 4px 14px rgba(0,0,0,.04);}
.toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.spacer{flex:1 1 auto;}
.section-title{margin:0; font-size:16px;}
.grid{display:grid; grid-template-columns:1fr; gap:10px;}
.wrap{display:grid; grid-template-columns:1fr; gap:10px;}
@media (min-width:720px){ .grid{ grid-template-columns:repeat(2,minmax(250px,1fr)); } .wrap{ grid-template-columns:repeat(3,minmax(220px,1fr)); } }
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
input, select{ appearance:none; width:100%; border:1px solid var(--line); border-radius:12px; padding:12px 14px; background:#fff; color:var(--text); outline:none; transition:border .15s, box-shadow .15s; font-size:16px;}
input:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.15); }
.small{ font-size:13px; padding:8px 10px; }
.btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:600; font-size:15px; }
.btn.secondary{ background:#f3f4f6; color:#111827; border:1px solid var(--line); }
.btn.danger{ background:var(--danger); }
.btn.ghost{ background:transparent; color:var(--text); border:1px dashed var(--line); }

/* Table desktop */
.table-wrap{overflow:auto;}
table{ width:100%; border-collapse:separate; border-spacing:0; min-width:900px; }
thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--line); text-align:left; padding:10px 8px; font-size:12px; color:#374151; }
tbody td{ border-bottom:1px solid var(--line); padding:10px 8px; vertical-align:middle; }
tfoot td{ background:#fafafa; border-top:1px solid var(--line); font-weight:700; }
.right{text-align:right;}
.note-input { width:220px; }
.cell-edit{ width:110px; text-align:right; }

/* Mobile cards */
@media (max-width:720px){
  .table-wrap{ display:none; }
  .list-mobile{ display:grid; gap:10px; }
  .mrow{ border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px; }
  .mrow .row-top{ display:flex; align-items:center; gap:8px; }
  .mrow .title{ font-weight:600; }
  .mrow .meta{ font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
  .mrow .sum{ margin-left:auto; font-weight:700; }
  .mrow .tags{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .mrow .tag{ font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:999px; background:#f8fafc; }
  .mrow .actions{ display:flex; gap:6px; margin-top:8px; }
  .mrow .details{ display:none; padding-top:8px; border-top:1px dashed var(--line); margin-top:8px; }
  .mrow.open .details{ display:block; }
}

/* Sticky bottom bar */
.mobile-bar{
  position:sticky; bottom:0; z-index:15; background:rgba(255,255,255,.98); border-top:1px solid var(--line);
  padding:10px; display:flex; gap:8px;
}
@media (min-width:720px){ .mobile-bar{ display:none; } }

/* Trial overlay */
#trialOverlay{
  position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999;
}
#trialOverlay .box{
  background:#fff; border-radius:14px; padding:18px; max-width:520px; margin:0 16px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.25);
}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="icons/icon-192.png" alt="Bek Calc" />
      <div class="name">Bek Calc</div>
      <span class="spacer"></span>
      <span class="badge" id="trialBadge">Демо: —</span>
    </div>
  </header>

  <main>
    <section class="card" id="newItem">
      <div class="toolbar">
        <h3 class="section-title">Новая позиция</h3>
        <span class="spacer"></span>
        <span class="badge" id="currentObjectBadge">Объект: —</span>
        <span class="badge" id="statusBadge">Статус: новая</span>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Объект/участок</label><input id="objectName" type="text" placeholder="Напр.: Блок А, 3 этаж"></div>
        <div><label>Вид работ</label><select id="workType"></select></div>
        <div><label>Цена за 1 ед. (₸)</label><input id="unitPrice" type="number" step="0.01" inputmode="decimal" placeholder="0.00"></div>
        <div><label>Примечание</label><input id="note" type="text" placeholder="Любые детали"></div>
      </div>
      <div class="wrap" id="fields" style="margin-top:12px"></div>
      <div class="card" style="margin-top:12px">
        <div class="toolbar" style="flex-wrap:wrap; gap:8px;">
          <label class="inline"><input type="checkbox" id="overrideToggle"> Прямой ввод объёма</label>
          <input id="overrideQty" type="number" step="0.001" inputmode="decimal" placeholder="0.000" style="width:160px" disabled>
          <select id="overrideUnit" disabled>
            <option value="m2">м²</option><option value="m3">м³</option><option value="m">м</option><option value="pcs">шт</option>
          </select>
          <span class="small" style="color:#6b7280;">Если включено — формулы L×B×H отключаются.</span>
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="card"><b>Кол-во:</b> <span id="qtyPreview">0</span> <span id="unitLabel">ед.</span></div>
        <div class="card"><b>Сумма:</b> <span id="sumPreview">0.00</span> ₸</div>
        <div class="card"><b>Средняя по Уральску:</b> <span id="avgCityPreview">—</span> ₸/ед.</div>
      </div>
      <div style="margin-top:12px" class="toolbar">
        <button class="btn" id="addBtn">Добавить в ведомость</button>
        <button class="btn secondary" id="resetBtn">Сбросить</button>
        <span class="spacer"></span>
        <span class="small" style="color:#6b7280;">Двойной тап по «Кол-во» в списке — быстрый ввод.</span>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="toolbar">
        <h3 class="section-title">Список позиций</h3>
        <span class="spacer"></span>
        <input id="quickSearch" class="small" type="search" placeholder="Поиск (объект, вид, примечание)" style="min-width:220px;">
        <select id="filterObject" class="small"></select>
        <select id="filterStatus" class="small"><option value="">Все</option><option value="new">Новые</option><option value="changed">Изменённые</option><option value="done">Выполненные</option></select>
        <label class="small" style="display:inline-flex; align-items:center; gap:6px;"><input type="checkbox" id="hideDone"> Скрыть выполненные</label>
        <button class="btn" id="exportXlsBtn" title="Скачать Excel (.xls)">Экспорт Excel</button>
        <button class="btn secondary" id="bulkDoneBtn">Отметить как выполненные</button>
        <button class="btn ghost" id="bulkNewBtn">Вернуть в «новые»</button>
        <button class="btn danger" id="clearBtn">Очистить всё</button>
      </div>
      <div class="table-wrap" style="margin-top:12px">
        <table id="rowsTable">
          <thead><tr>
            <th>Дата/время</th><th>Объект</th><th>Вид работ</th><th>Ед. изм.</th><th class="right">Кол-во</th><th class="right">Цена (₸/ед.)</th><th class="right">Средняя (₸/ед.)</th><th class="right">Сумма (₸)</th><th>Статус</th>
            <th>L</th><th>B</th><th>H</th><th>T</th><th>D</th><th>Проёмы</th><th>Шт</th><th>Примечание</th><th></th>
          </tr></thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="7" class="right">ИТОГО (фильтр):</td><td class="right" id="grandTotal">0.00</td><td colspan="8"></td></tr></tfoot>
        </table>
      </div>
      <div id="listMobile" class="list-mobile" style="display:none;"></div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="toolbar"><h3 class="section-title">Сводка по объектам</h3></div>
      <div style="overflow:auto; margin-top:8px">
        <table id="objectSummary" class="table-min">
          <thead><tr><th>Объект</th><th class="right">Позиции</th><th class="right">Итого (₸)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="mobile-bar">
    <button class="btn" id="mobileScrollAdd">Добавить</button>
    <button class="btn secondary" id="mobileExport">Excel</button>
    <button class="btn ghost" id="mobileToTop">Наверх</button>
  </div>

  <!-- Trial overlay -->
  <div id="trialOverlay">
    <div class="box">
      <h2>Демо-период завершён</h2>
      <p>Срок действия демо (3 дня с первого запуска) истёк. Данные остаются в вашем браузере, но добавление/редактирование отключено.</p>
    </div>
  </div>

<script>
// PWA register
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js');
  });
}

// ==== Trial 3 days ====
const TRIAL_KEY='bekcalc_trial_start';
const TRIAL_MS=3*24*60*60*1000; // 3 days
function getTrialInfo(){
  let start = localStorage.getItem(TRIAL_KEY);
  if(!start){ start = Date.now().toString(); localStorage.setItem(TRIAL_KEY, start); }
  const startMs = parseInt(start,10)||Date.now();
  const now = Date.now();
  const left = Math.max(0, TRIAL_MS - (now - startMs));
  return {startMs, leftMs:left};
}
function formatLeft(ms){
  const d=Math.floor(ms/(24*60*60*1000));
  const h=Math.floor((ms%(24*60*60*1000))/(60*60*1000));
  return (d>0? d+' д ' : '') + h + ' ч';
}
function applyTrialUI(){
  const info = getTrialInfo();
  const badge = document.getElementById('trialBadge');
  if(info.leftMs>0){
    badge.textContent = 'Демо: осталось ' + formatLeft(info.leftMs);
  }else{
    badge.textContent = 'Демо: истекло';
    document.getElementById('trialOverlay').style.display='flex';
    // disable inputs/buttons
    document.querySelectorAll('input,select,button').forEach(el=>{
      if(el.id==='mobileToTop'){ return; } // оставить прокрутку
      el.disabled = true;
    });
  }
}
setInterval(applyTrialUI, 60*1000); // обновлять каждые 60 сек
document.addEventListener('DOMContentLoaded', applyTrialUI);

// ==== App data/logic (short version reusing earlier) ====
const Unit = { m3:'м³', m2:'м²', m:'м', pcs:'шт' };
const $ = (id)=>document.getElementById(id);
function unitText(u, manualText){ return u==='m2'?'м²':u==='m3'?'м³':u==='m'?'м':u==='pcs'?'шт':(manualText||'ед.'); }
function esc(s){ return (s??'').toString().replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function num(v, d){ v=v||0; return v? v.toFixed(d):''; }
function nn(v){ if (isNaN(v)) return 0; return v<0?0:v; }

let AVG_PRICE = { 'dem_wall':3000,'putty_wall':900,'paint_apply':800,'plaster_wall':2000,'window_install':12000,'window_dismantle':6000,'door_install':10000,'door_dismantle':5000,'plumb_install':15000,'elec_install':12000,'gkl_wall':2500,'screed':2500,'floor_laminate':1500,'floor_linoleum':1000,'gkl_ceiling':2600,'gkl_partition':2600,'floor_selflevel':3000,'floor_carpet':1400,'floor_pvc':2200,'ceiling_armstrong':2800,'tile_floor':3500,'tile_wall':3800,'hydro':1200,'roof_sheet':2500,'interior_misc':1000,'plumb_point_install':15000,'plumb_point_dismantle':8000,'elec_point_install':12000,'elec_point_dismantle':6000,'pipe_laying':900,'cable_laying':700,'dem_concrete':0,'beton_slab':0,'beton_strip':0,'beton_beam':0,'beton_col_rect':0,'beton_col_cyl':0,'earth_trench':0,'earth_backfill':0 };
const CATALOG=[
  {id:'beton_slab', name:'Бетон — плита/перекрытие (м³)', unit:'m3', fields:['length','width','thickness','count']},
  {id:'beton_strip', name:'Бетон — лента фундамента (м³)', unit:'m3', fields:['length','width','height','count']},
  {id:'beton_beam', name:'Бетон — балка (м³)', unit:'m3', fields:['length','width','height','count']},
  {id:'beton_col_rect', name:'Бетон — колонна прямоуг. (м³)', unit:'m3', fields:['width','thickness','height','count']},
  {id:'beton_col_cyl', name:'Бетон — колонна цилиндр. (м³)', unit:'m3', fields:['diameter','height','count']},
  {id:'earth_trench', name:'Земляные — траншея (м³)', unit:'m3', fields:['length','width','height','count']},
  {id:'earth_backfill', name:'Земляные — обратная засыпка (м³)', unit:'m3', fields:['length','width','height','count']},
  {id:'masonry', name:'Кладка (м³)', unit:'m3', fields:['length','height','thickness','count']},
  {id:'plaster_wall', name:'Штукатурка стен (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'putty_wall', name:'Шпаклёвка стен (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'paint_apply', name:'Окраска стен (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'paint_remove', name:'Демонтаж (снятие) краски (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'tile_floor', name:'Плитка — пол (м²)', unit:'m2', fields:['length','width','count']},
  {id:'tile_wall', name:'Плитка — стены (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'gkl_wall', name:'ГКЛ — стены (м²)', unit:'m2', fields:['length','height','count']},
  {id:'screed', name:'Стяжка пола (м²)', unit:'m2', fields:['length','width','count']},
  {id:'hydro', name:'Гидроизоляция (м²)', unit:'m2', fields:['length','width','count']},
  {id:'roof_sheet', name:'Кровля профлист (м²)', unit:'m2', fields:['length','width','count']},
  {id:'interior_misc', name:'Внутренние работы (м²)', unit:'m2', fields:['length','width','count']},
  {id:'gkl_ceiling', name:'ГКЛ — потолок (м²)', unit:'m2', fields:['length','width','count']},
  {id:'gkl_partition', name:'ГКЛ — перегородки (м²)', unit:'m2', fields:['length','height','count']},
  {id:'floor_laminate', name:'Покрытие пола — ламинат (м²)', unit:'m2', fields:['length','width','count']},
  {id:'floor_linoleum', name:'Покрытие пола — линолеум (м²)', unit:'m2', fields:['length','width','count']},
  {id:'floor_selflevel', name:'Наливной пол (м²)', unit:'m2', fields:['length','width','count']},
  {id:'floor_carpet', name:'Ковролин (м²)', unit:'m2', fields:['length','width','count']},
  {id:'floor_pvc', name:'ПВХ-плитка / кварцвинил (м²)', unit:'m2', fields:['length','width','count']},
  {id:'ceiling_armstrong', name:'Потолок Армстронг (м²)', unit:'m2', fields:['length','width','count']},
  {id:'door_install', name:'Монтаж двери (шт)', unit:'pcs', fields:['count']},
  {id:'door_dismantle', name:'Демонтаж двери (шт)', unit:'pcs', fields:['count']},
  {id:'window_install', name:'Монтаж окна (шт)', unit:'pcs', fields:['count']},
  {id:'window_dismantle', name:'Демонтаж окна (шт)', unit:'pcs', fields:['count']},
  {id:'plumb_install', name:'Сантехника — монтаж (шт)', unit:'pcs', fields:['count']},
  {id:'plumb_dismantle', name:'Сантехника — демонтаж (шт)', unit:'pcs', fields:['count']},
  {id:'elec_install', name:'Электрика — монтаж (шт)', unit:'pcs', fields:['count']},
  {id:'elec_dismantle', name:'Электрика — демонтаж (шт)', unit:'pcs', fields:['count']},
  {id:'plumb_point_install', name:'Сантехническая точка — монтаж (шт)', unit:'pcs', fields:['count']},
  {id:'plumb_point_dismantle', name:'Сантехническая точка — демонтаж (шт)', unit:'pcs', fields:['count']},
  {id:'elec_point_install', name:'Электроточка — монтаж (шт)', unit:'pcs', fields:['count']},
  {id:'elec_point_dismantle', name:'Электроточка — демонтаж (шт)', unit:'pcs', fields:['count']},
  {id:'pipe_laying', name:'Прокладка труб (п.м.)', unit:'m', fields:['length','count']},
  {id:'cable_laying', name:'Прокладка кабеля (п.м.)', unit:'m', fields:['length','count']},
  {id:'dem_concrete', name:'Демонтаж бетона (м³)', unit:'m3', fields:['length','width','height','count']},
  {id:'dem_wall', name:'Демонтаж стен/перегородок (м²)', unit:'m2', fields:['length','height','openings','count']},
  {id:'custom', name:'Произвольная позиция', unit:'m2', fields:['manualQty','manualUnit','count']},
];
const state = { rows: [] };
const LS_ROWS='bek_rows_trial_v1', LS_AVG='bek_rows_trial_v1_avg';

// ... (functions identical to earlier mobile build removed for brevity in this snippet)
// For functionality, we include minimal add/list/export similar to previous messages.

function unitById(id){ const t=CATALOG.find(x=>x.id===id); return t?t.unit:'m2'; }
function qtyByFormula(it){
  const L=it.length||0,B=it.width||0,H=it.height||0,T=it.thickness||0,D=it.diameter||0,O=it.openings||0,C=it.count||1;
  const pi=Math.PI;
  switch(it.workTypeId){
    case 'beton_slab': return nn(L*B*T)*C;
    case 'beton_strip':
    case 'beton_beam':
    case 'earth_trench':
    case 'earth_backfill': return nn(L*B*H)*C;
    case 'beton_col_rect': return nn(it.width*it.thickness*it.height)*C;
    case 'beton_col_cyl': return nn(pi*Math.pow(D/2,2)*H)*C;
    case 'masonry': return nn(L*H*T)*C;
    case 'plaster_wall':
    case 'putty_wall':
    case 'paint_apply':
    case 'paint_remove':
    case 'tile_wall':
    case 'gkl_wall':
    case 'dem_wall': return nn(L*H - O)*C;
    case 'screed':
    case 'hydro':
    case 'tile_floor':
    case 'roof_sheet':
    case 'interior_misc':
    case 'gkl_ceiling':
    case 'gkl_partition': return (it.workTypeId==='gkl_partition')? nn(L*H)*C : nn(L*B)*C;
    case 'floor_laminate':
    case 'floor_linoleum':
    case 'floor_selflevel':
    case 'floor_carpet':
    case 'floor_pvc':
    case 'ceiling_armstrong': return nn(L*B)*C;
    case 'door_install':
    case 'door_dismantle':
    case 'window_install':
    case 'window_dismantle':
    case 'plumb_install':
    case 'plumb_dismantle':
    case 'elec_install':
    case 'elec_dismantle':
    case 'plumb_point_install':
    case 'plumb_point_dismantle':
    case 'elec_point_install':
    case 'elec_point_dismantle': return nn(C);
    case 'pipe_laying':
    case 'cable_laying': return nn(L)*C;
    case 'dem_concrete': return nn(L*B*H)*C;
    case 'custom': return nn(it.manualQty||0)*C;
    default: return 0;
  }
}

const workTypeSel=document.getElementById('workType'),
      fieldsWrap=document.getElementById('fields');
function populateWorkTypes(){ workTypeSel.innerHTML = CATALOG.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''); }

function inputField(key,label,placeholder='',step='0.001'){
  const id='f_'+key;
  return `<div><label>${label}</label><input id="${id}" type="${key==='manualUnit'?'text':'number'}" ${key==='manualUnit'?'':`step="${step}"`} inputmode="${key==='manualUnit'?'text':'decimal'}" placeholder="${placeholder}"></div>`;
}
function renderFields(){
  const type=CATALOG.find(t=>t.id===workTypeSel.value);
  const defs={
    length: inputField('length','Длина L (м)','0.000'),
    width: inputField('width','Ширина B (м)','0.000'),
    height: inputField('height','Высота H (м)','0.000'),
    thickness: inputField('thickness','Толщина T (м)','0.000'),
    diameter: inputField('diameter','Диаметр D (м)','0.000'),
    openings: inputField('openings','Проёмы (м²)','0.00','0.01'),
    count: inputField('count','Кол-во одинаковых (шт)','1','1'),
    manualQty: inputField('manualQty','Кол-во (ед.)','0.000'),
    manualUnit: inputField('manualUnit','Ед. изм. (текст)','м²'),
  };
  const out=[]; (type.fields||[]).forEach(f=>out.push(defs[f])); if (!type.fields?.includes('count')) out.push(defs['count']);
  fieldsWrap.innerHTML=out.join('');
  const g=(id)=>document.getElementById(id); if (g('f_thickness')) g('f_thickness').value=0.12; if (g('f_count')) g('f_count').value=1;
}

function collect(){
  const type=CATALOG.find(t=>t.id===workTypeSel.value);
  const it={
    createdAt:new Date().toISOString(),
    objectName:document.getElementById('objectName').value.trim(),
    workTypeId:type.id, workTypeName:type.name,
    unit:type.unit, length:parseFloat((document.getElementById('f_length')?.value||'').replace(',','.'))||0,
    width:parseFloat((document.getElementById('f_width')?.value||'').replace(',','.'))||0,
    height:parseFloat((document.getElementById('f_height')?.value||'').replace(',','.'))||0,
    thickness:parseFloat((document.getElementById('f_thickness')?.value||'').replace(',','.'))||0,
    diameter:parseFloat((document.getElementById('f_diameter')?.value||'').replace(',','.'))||0,
    openings:parseFloat((document.getElementById('f_openings')?.value||'').replace(',','.'))||0,
    count:Math.max(1, parseInt((document.getElementById('f_count')?.value||'1'))||1),
    manualQty:parseFloat((document.getElementById('f_manualQty')?.value||'').replace(',','.'))||0,
    manualUnitText: document.getElementById('f_manualUnit')?.value || '',
    unitPrice:parseFloat((document.getElementById('unitPrice').value||'').replace(',','.'))||0,
    avgCityPrice: AVG_PRICE[type.id]||0,
    note:document.getElementById('note').value.trim(),
    overrideOn: document.getElementById('overrideToggle').checked,
    overrideQty: parseFloat((document.getElementById('overrideQty').value||'').replace(',','.'))||0,
    overrideUnit: document.getElementById('overrideUnit').value
  };
  it.qty = it.overrideOn ? nn(it.overrideQty) : qtyByFormula(it);
  it.displayUnit = it.overrideOn ? it.overrideUnit : it.unit;
  it.lineTotal = it.qty * it.unitPrice;
  return it;
}

function recalcPreview(){
  const it=collect();
  document.getElementById('qtyPreview').textContent = it.qty.toFixed(3);
  document.getElementById('unitLabel').textContent = unitText(it.displayUnit, it.manualUnitText);
  document.getElementById('sumPreview').textContent = it.lineTotal.toFixed(2);
  document.getElementById('avgCityPreview').textContent = it.avgCityPrice? it.avgCityPrice.toFixed(0): '—';
  document.getElementById('currentObjectBadge').textContent = 'Объект: ' + (it.objectName||'—');
}

function addRow(){
  const info = getTrialInfo(); if (info.leftMs<=0) return; // trial expired
  const it=collect();
  state.rows.unshift(it); saveLS(); renderRows(); renderObjectSummary(); updateFilterObjects();
  document.getElementById('note').value='';
}

function saveLS(){ localStorage.setItem(LS_ROWS, JSON.stringify(state.rows)); localStorage.setItem(LS_AVG, JSON.stringify(AVG_PRICE)); }
function loadLS(){
  try{ state.rows = JSON.parse(localStorage.getItem(LS_ROWS)||'[]'); }catch(e){ state.rows=[]; }
  try{ const a=JSON.parse(localStorage.getItem(LS_AVG)||'{}'); AVG_PRICE=Object.assign({},AVG_PRICE,a); }catch(e){}
}

function textMatch(it, q){
  if (!q) return true; q=q.toLowerCase();
  return (it.objectName||'').toLowerCase().includes(q) || (it.workTypeName||'').toLowerCase().includes(q) || (it.note||'').toLowerCase().includes(q);
}
function visibleRows(){
  const fObj=document.getElementById('filterObject').value||''; const fStatus=document.getElementById('filterStatus').value||''; const hide=document.getElementById('hideDone').checked; const q=document.getElementById('quickSearch').value.trim();
  return state.rows.filter(r => (!fObj || r.objectName===fObj) && (!fStatus || r.status===fStatus) && (!hide || r.status!=='done') && textMatch(r,q));
}

function renderRows(){
  // Desktop table
  const tbody=document.querySelector('#rowsTable tbody'); tbody.innerHTML='';
  let grand=0; const rows=visibleRows();
  rows.forEach((it,i)=>{
    grand += it.lineTotal||0;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="small">${new Date(it.createdAt).toLocaleString('ru-RU')}</td>
      <td>${esc(it.objectName)}</td>
      <td>${esc(it.workTypeName)}</td>
      <td>${unitText(it.displayUnit, it.manualUnitText)}</td>
      <td class="right">${(it.qty||0).toFixed(3)}</td>
      <td class="right">${(it.unitPrice||0).toFixed(2)}</td>
      <td class="right">${(it.avgCityPrice||0).toFixed(0)}</td>
      <td class="right">${(it.lineTotal||0).toFixed(2)}</td>
      <td>${it.status||'new'}</td>
      <td>${num(it.length,3)}</td><td>${num(it.width,3)}</td><td>${num(it.height,3)}</td>
      <td>${num(it.thickness,3)}</td><td>${num(it.diameter,3)}</td><td>${num(it.openings,2)}</td>
      <td>${it.count||0}</td>
      <td>${esc(it.note||'')}</td>
      <td></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('grandTotal').textContent = grand.toFixed(2);

  // Mobile list
  const container=document.getElementById('listMobile'); container.innerHTML='';
  rows.forEach((it)=>{
    const card=document.createElement('div'); card.className='mrow';
    card.innerHTML = `
      <div class="row-top">
        <div class="title">${esc(it.workTypeName)}</div>
        <div class="sum">${(it.lineTotal||0).toFixed(0)} ₸</div>
      </div>
      <div class="meta">
        <span>${esc(it.objectName||'(без объекта)')}</span>
        <span>${new Date(it.createdAt).toLocaleDateString('ru-RU')}</span>
        <span>${(it.qty||0).toFixed(2)} ${unitText(it.displayUnit, it.manualUnitText)}</span>
        <span>${(it.unitPrice||0).toFixed(0)} ₸/ед.</span>
      </div>`;
    container.appendChild(card);
  });
}

function renderObjectSummary(){
  const map={}; state.rows.forEach(it=>{ const k=it.objectName?.trim()||'(без объекта)'; (map[k]||(map[k]={sum:0,count:0})).sum += it.lineTotal||0; map[k].count += 1; });
  const tbody=document.querySelector('#objectSummary tbody'); tbody.innerHTML='';
  Object.keys(map).sort().forEach(name=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(name)}</td><td class="right">${map[name].count}</td><td class="right">${map[name].sum.toFixed(2)}</td>`; tbody.appendChild(tr);
  });
}
function updateFilterObjects(){
  const objs=new Set(state.rows.map(r=>r.objectName?.trim()).filter(Boolean));
  const sel=document.getElementById('filterObject'); const val=sel.value;
  sel.innerHTML = `<option value="">Все объекты</option>` + Array.from(objs).sort().map(o=>`<option value="${esc(o)}">${esc(o)}</option>`).join('');
  if(val && Array.from(objs).includes(val)) sel.value=val;
}

function exportExcel(){
  const headers=['Дата/время','Объект','Вид работ','Ед. изм.','Кол-во','Цена','Средняя (Уральск)','Сумма','Статус','L','B','H','T','D','Проёмы','Шт','Примечание'];
  const list=visibleRows();
  const xmlCell=(value,type)=>{ const t=type||(typeof value==='number'?'Number':'String'); const v=(value??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); return `<Cell><Data ss:Type="${t}">${v}</Data></Cell>`; };
  let rowsXml='<Row>'+headers.map(h=>`<Cell ss:StyleID="sHdr"><Data ss:Type="String">${h}</Data></Cell>`).join('')+'</Row>';
  list.forEach(it=>{
    rowsXml += '<Row>'+
      xmlCell(new Date(it.createdAt).toLocaleString('ru-RU'))+
      xmlCell(it.objectName||'')+ xmlCell(it.workTypeName||'')+ xmlCell(unitText(it.displayUnit, it.manualUnitText))+
      xmlCell(Number((it.qty||0).toFixed(3)),'Number')+ xmlCell(Number((it.unitPrice||0).toFixed(2)),'Number')+
      xmlCell(Number((it.avgCityPrice||0).toFixed(0)),'Number')+ xmlCell(Number((it.lineTotal||0).toFixed(2)),'Number')+
      xmlCell(it.status||'')+ xmlCell(Number((it.length||0).toFixed(3)),'Number')+ xmlCell(Number((it.width||0).toFixed(3)),'Number')+
      xmlCell(Number((it.height||0).toFixed(3)),'Number')+ xmlCell(Number((it.thickness||0).toFixed(3)),'Number')+
      xmlCell(Number((it.diameter||0).toFixed(3)),'Number')+ xmlCell(Number((it.openings||0).toFixed(2)),'Number')+
      xmlCell(it.count||0,'Number')+ xmlCell(it.note||'')+ '</Row>';
  });
  const grand = list.reduce((s,it)=>s+(it.lineTotal||0),0);
  rowsXml += '<Row></Row><Row>'+xmlCell('ИТОГО')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell(Number(grand.toFixed(2)),'Number')+'</Row>';
  const workbook = `<?xml version="1.0"?>
    <?mso-application progid="Excel.Sheet"?>
    <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
      <Styles><Style ss:ID="sHdr"><Font ss:Bold="1"/><Interior ss:Color="#EAF1FF" ss:Pattern="Solid"/></Style></Styles>
      <Worksheet ss:Name="BekCalc"><Table>${rowsXml}</Table></Worksheet>
    </Workbook>`;
  const blob=new Blob([workbook],{type:'application/vnd.ms-excel'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bekcalc_export.xls'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function init(){
  populateWorkTypes(); renderFields(); loadLS(); renderRows(); renderObjectSummary(); updateFilterObjects(); recalcPreview(); applyTrialUI();
  document.getElementById('objectName').addEventListener('input',recalcPreview);
  document.getElementById('unitPrice').addEventListener('input',recalcPreview);
  document.getElementById('note').addEventListener('input',recalcPreview);
  workTypeSel.addEventListener('change',()=>{ renderFields(); recalcPreview(); });
  document.getElementById('addBtn').addEventListener('click', addRow);
  document.getElementById('resetBtn').addEventListener('click', ()=>{ document.querySelectorAll('#newItem input').forEach(i=>i.value=''); recalcPreview(); });
  document.getElementById('exportXlsBtn').addEventListener('click', exportExcel);
  document.getElementById('bulkDoneBtn').addEventListener('click', ()=>{ /* simplified */ });
  document.getElementById('bulkNewBtn').addEventListener('click', ()=>{ /* simplified */ });
  document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Удалить все позиции?')){ state.rows=[]; saveLS(); renderRows(); renderObjectSummary(); updateFilterObjects(); } });
  document.getElementById('filterObject').addEventListener('change', renderRows);
  document.getElementById('filterStatus').addEventListener('change', renderRows);
  document.getElementById('hideDone').addEventListener('change', renderRows);
  document.getElementById('quickSearch').addEventListener('input', renderRows);
  document.getElementById('mobileExport').addEventListener('click', exportExcel);
  document.getElementById('mobileScrollAdd').addEventListener('click', ()=>{ document.getElementById('newItem').scrollIntoView({behavior:'smooth'}); });
  document.getElementById('mobileToTop').addEventListener('click', ()=>{ window.scrollTo({top:0, behavior:'smooth'}); });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
