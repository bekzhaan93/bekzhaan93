<!DOCTYPE html>
<html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bek Calc — ведомость работ</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f7f8fa;margin:0;color:#111827}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 16px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:44px;height:44px;border-radius:10px;border:1px solid #e5e7eb}
.name{font-weight:800}
main{max-width:1100px;margin:16px auto;padding:0 14px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
.wrap{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}.wrap{grid-template-columns:repeat(3,1fr)}}
label{font-size:12px;color:#6b7280;margin-bottom:6px;display:block}
input,select{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
.btn{background:#2563eb;color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer}
.btn.secondary{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px}
thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e5e7eb;text-align:left;padding:10px 8px;font-size:12px;color:#374151}
tbody td{border-bottom:1px solid #e5e7eb;padding:10px 8px}
.right{text-align:right}
.badge{display:inline-block;padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#f8fafc;font-size:12px}
.help{font-size:12px;color:#6b7280}
</style>
</head><body>
<header><div class="brand"><img src="icons/icon-192.png"><div class="name">Bek Calc</div><span style="flex:1"></span><span class="badge">Офлайн • без ограничений</span></div></header>
<main>
<section class="card" id="newItem">
  <div class="grid">
    <div><label>Объект/участок</label><input id="objectName" placeholder="Блок А, 3 этаж"></div>
    <div><label>Вид работ</label><select id="workType"></select></div>
    <div><label>Цена за 1 ед. (₸)</label><input id="unitPrice" type="number" step="0.01" inputmode="decimal" placeholder="0.00"></div>
    <div><label>Примечание</label><input id="note" placeholder="Детали"></div>
  </div>
  <div class="wrap" id="fields" style="margin-top:12px"></div>
  <div class="card" style="margin-top:12px">
    <label><input type="checkbox" id="overrideToggle"> Прямой ввод объёма</label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="overrideQty" type="number" step="0.001" inputmode="decimal" placeholder="0.000" style="max-width:180px" disabled>
      <select id="overrideUnit" disabled><option value="m2">м²</option><option value="m3">м³</option><option value="m">м</option><option value="pcs">шт</option></select>
      <span class="help">В режиме прямого ввода формулы не используются</span>
    </div>
  </div>
  <div class="grid" style="margin-top:12px">
    <div class="card"><b>Кол-во:</b> <span id="qtyPreview">0</span> <span id="unitLabel">ед.</span></div>
    <div class="card"><b>Сумма:</b> <span id="sumPreview">0.00</span> ₸</div>
    <div class="card"><b>Оценка кирпича:</b> <span id="brickPreview">—</span></div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px">
    <button class="btn" id="addBtn">Добавить в ведомость</button>
    <button class="btn secondary" id="resetBtn">Сбросить</button>
  </div>
</section>

<section class="card" style="margin-top:16px">
  <div style="display:flex;align-items:center;gap:8px">
    <h3 style="margin:0">Список позиций</h3><span style="flex:1"></span>
    <button class="btn" id="exportXlsBtn">Экспорт Excel</button>
  </div>
  <div class="table-wrap" style="margin-top:12px">
    <table id="rowsTable"><thead><tr>
      <th>Дата/время</th><th>Объект</th><th>Вид работ</th><th>Ед. изм.</th><th class="right">Кол-во</th><th class="right">Цена (₸/ед.)</th><th class="right">Сумма (₸)</th><th>Примечание</th>
    </tr></thead><tbody></tbody><tfoot><tr><td colspan="5"></td><td class="right">ИТОГО:</td><td class="right" id="grandTotal">0.00</td><td></td></tr></tfoot></table>
  </div>
</section>
</main>

<script>
if('serviceWorker' in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js'))}

const $=id=>document.getElementById(id);
const Unit={m3:'м³',m2:'м²',m:'м',pcs:'шт'};
function unitText(u,manualText){return u==='m2'?'м²':u==='m3'?'м³':u==='m'?'м':u==='pcs'?'шт':(manualText||'ед.')}
function esc(s){return (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function nn(v){v=parseFloat((v??0).toString().replace(',','.'));if(isNaN(v))return 0;return v<0?0:v}
function int(v){v=parseInt((v??0).toString().replace(',','.'));return isNaN(v)?0:Math.max(0,v)}

const BRICK_TYPES=[
  {id:'brick_single',name:'Одинарный 250×120×65',faceArea:0.25*0.065},
  {id:'brick_onehalf',name:'Полуторный 250×120×88',faceArea:0.25*0.088},
  {id:'brick_double',name:'Двойной 250×120×138',faceArea:0.25*0.138},
];
const THICKNESS=[
  {id:'t_0_12',name:'Толщина 0.12 м (½ кирпича)',value:0.12},
  {id:'t_0_25',name:'Толщина 0.25 м (1 кирпич)',value:0.25},
  {id:'t_0_38',name:'Толщина 0.38 м (1.5 кирпича)',value:0.38},
  {id:'t_0_51',name:'Толщина 0.51 м (2 кирпича)',value:0.51}
];

const CATALOG=[
  {id:'beton_slab',name:'Бетон — плита/перекрытие (м³)',unit:'m3',fields:['length','width','thickness','count']},
  {id:'beton_strip',name:'Бетон — лента (м³)',unit:'m3',fields:['length','width','height','count']},
  {id:'beton_beam',name:'Бетон — балка (м³)',unit:'m3',fields:['length','width','height','count']},
  {id:'beton_col_rect',name:'Бетон — колонна прямоуг. (м³)',unit:'m3',fields:['width','thickness','height','count']},
  {id:'beton_col_cyl',name:'Бетон — колонна цилиндр. (м³)',unit:'m3',fields:['diameter','height','count']},
  {id:'earth_trench',name:'Земляные — траншея (м³)',unit:'m3',fields:['length','width','height','count']},
  {id:'earth_backfill',name:'Засыпка (м³)',unit:'m3',fields:['length','width','height','count']},
  {id:'masonry',name:'Кладка (м³)',unit:'m3',fields:['length','height','thickness','count']},
  {id:'masonry_wall',name:'Кирпичная стена (м²) — толщина и тип кирпича',unit:'m2',fields:['length','height','openings','count','thicknessMode','brickType']},
  {id:'plaster_wall',name:'Штукатурка стен (м²)',unit:'m2',fields:['length','height','openings','count']},
  {id:'putty_wall',name:'Шпаклёвка стен (м²)',unit:'m2',fields:['length','height','openings','count']},
  {id:'paint_apply',name:'Окраска стен (м²)',unit:'m2',fields:['length','height','openings','count']},
  {id:'tile_floor',name:'Плитка — пол (м²)',unit:'m2',fields:['length','width','count']},
  {id:'tile_wall',name:'Плитка — стены (м²)',unit:'m2',fields:['length','height','openings','count']},
  {id:'gkl_wall',name:'ГКЛ — стены (м²)',unit:'m2',fields:['length','height','count']},
  {id:'gkl_ceiling',name:'ГКЛ — потолок (м²)',unit:'m2',fields:['length','width','count']},
  {id:'gkl_partition',name:'ГКЛ — перегородки (м²)',unit:'m2',fields:['length','height','count']},
  {id:'screed',name:'Стяжка пола (м²)',unit:'m2',fields:['length','width','count']},
  {id:'hydro',name:'Гидроизоляция (м²)',unit:'m2',fields:['length','width','count']},
  {id:'roof_sheet',name:'Кровля профлист (м²)',unit:'m2',fields:['length','width','count']},
  {id:'interior_misc',name:'Внутренние работы (м²)',unit:'m2',fields:['length','width','count']},
  {id:'floor_laminate',name:'Ламинат (м²)',unit:'m2',fields:['length','width','count']},
  {id:'floor_linoleum',name:'Линолеум (м²)',unit:'m2',fields:['length','width','count']},
  {id:'floor_selflevel',name:'Наливной пол (м²)',unit:'m2',fields:['length','width','count']},
  {id:'floor_carpet',name:'Ковролин (м²)',unit:'m2',fields:['length','width','count']},
  {id:'floor_pvc',name:'ПВХ-плитка (м²)',unit:'m2',fields:['length','width','count']},
  {id:'ceiling_armstrong',name:'Потолок Армстронг (м²)',unit:'m2',fields:['length','width','count']},
  {id:'door_install',name:'Монтаж двери (шт)',unit:'pcs',fields:['count']},
  {id:'door_dismantle',name:'Демонтаж двери (шт)',unit:'pcs',fields:['count']},
  {id:'window_install',name:'Монтаж окна (шт)',unit:'pcs',fields:['count']},
  {id:'window_dismantle',name:'Демонтаж окна (шт)',unit:'pcs',fields:['count']},
  {id:'plumb_install',name:'Сантехника — монтаж (шт)',unit:'pcs',fields:['count']},
  {id:'plumb_dismantle',name:'Сантехника — демонтаж (шт)',unit:'pcs',fields:['count']},
  {id:'elec_install',name:'Электрика — монтаж (шт)',unit:'pcs',fields:['count']},
  {id:'elec_dismantle',name:'Электрика — демонтаж (шт)',unit:'pcs',fields:['count']},
  {id:'plumb_point_install',name:'Сантехническая точка — монтаж (шт)',unit:'pcs',fields:['count']},
  {id:'plumb_point_dismantle',name:'Сантехническая точка — демонтаж (шт)',unit:'pcs',fields:['count']},
  {id:'elec_point_install',name:'Электроточка — монтаж (шт)',unit:'pcs',fields:['count']},
  {id:'elec_point_dismantle',name:'Электроточка — демонтаж (шт)',unit:'pcs',fields:['count']},
  {id:'pipe_laying',name:'Прокладка труб (п.м.)',unit:'m',fields:['length','count']},
  {id:'cable_laying',name:'Прокладка кабеля (п.м.)',unit:'m',fields:['length','count']},
  {id:'dem_concrete',name:'Демонтаж бетона (м³)',unit:'m3',fields:['length','width','height','count']},
  {id:'dem_wall',name:'Демонтаж стен/перегородок (м²)',unit:'m2',fields:['length','height','openings','count']},
  {id:'custom',name:'Произвольная позиция',unit:'m2',fields:['manualQty','manualUnit','count']},
];

function populateWorkTypes(){ $('workType').innerHTML=CATALOG.map(t=>`<option value="${t.id}">${t.name}</option>`).join('') }

function inputField(key,label,placeholder='',step='0.001'){
  const id='f_'+key; return `<div><label>${label}</label><input id="${id}" type="${key==='manualUnit'?'text':'number'}" ${key==='manualUnit'?'':`step="${step}"`} inputmode="${key==='manualUnit'?'text':'decimal'}" placeholder="${placeholder}"></div>`;
}
function selectField(key,label,opts){ const id='f_'+key; const o=opts.map(e=>`<option value="${e.id}">${e.name}</option>`).join(''); return `<div><label>${label}</label><select id="${id}">${o}</select></div>`; }

function renderFields(){
  const type=CATALOG.find(t=>t.id===$('workType').value);
  const defs={
    length: inputField('length','Длина L (м)','0.000'),
    width: inputField('width','Ширина B (м)','0.000'),
    height: inputField('height','Высота H (м)','0.000'),
    thickness: inputField('thickness','Толщина T (м)','0.120'),
    diameter: inputField('diameter','Диаметр D (м)','0.000'),
    openings: inputField('openings','Проёмы (м²)','0.00','0.01'),
    count: inputField('count','Кол-во одинаковых (шт)','1','1'),
    manualQty: inputField('manualQty','Кол-во (ед.)','0.000'),
    manualUnit: inputField('manualUnit','Ед. изм. (текст)','м²'),
    thicknessMode: selectField('thicknessMode','Толщина стены',THICKNESS),
    brickType: selectField('brickType','Тип кирпича',BRICK_TYPES)
  };
  const out=[]; (type.fields||[]).forEach(f=>out.push(defs[f])); if(!type.fields?.includes('count')) out.push(defs['count']);
  $('fields').innerHTML=out.join('');
  bindFieldListeners(); recalcPreview();
}

function qtyByFormula(it){
  const L=nn(it.length),B=nn(it.width),H=nn(it.height),T=nn(it.thickness),D=nn(it.diameter),O=nn(it.openings),C=Math.max(1,int(it.count)||1);
  const pi=Math.PI;
  switch(it.workTypeId){
    case 'beton_slab': return (L*B*T)*C;
    case 'beton_strip':
    case 'beton_beam':
    case 'earth_trench':
    case 'earth_backfill': return (L*B*H)*C;
    case 'beton_col_rect': return (nn(it.width)*nn(it.thickness)*H)*C;
    case 'beton_col_cyl': return (pi*Math.pow(D/2,2)*H)*C;
    case 'masonry': return (L*H*T)*C;
    case 'plaster_wall':
    case 'putty_wall':
    case 'paint_apply':
    case 'paint_remove':
    case 'tile_wall':
    case 'gkl_wall':
    case 'dem_wall': return Math.max(0,L*H-O)*C;
    case 'screed':
    case 'hydro':
    case 'tile_floor':
    case 'roof_sheet':
    case 'interior_misc':
    case 'gkl_ceiling':
    case 'gkl_partition': return it.workTypeId==='gkl_partition' ? (L*H)*C : (L*B)*C;
    case 'floor_laminate':
    case 'floor_linoleum':
    case 'floor_selflevel':
    case 'floor_carpet':
    case 'floor_pvc':
    case 'ceiling_armstrong': return (L*B)*C;
    case 'door_install':
    case 'door_dismantle':
    case 'window_install':
    case 'window_dismantle':
    case 'plumb_install':
    case 'plumb_dismantle':
    case 'elec_install':
    case 'elec_dismantle':
    case 'plumb_point_install':
    case 'plumb_point_dismantle':
    case 'elec_point_install':
    case 'elec_point_dismantle': return C;
    case 'pipe_laying':
    case 'cable_laying': return (L)*C;
    case 'dem_concrete': return (L*B*H)*C;
    case 'masonry_wall': return Math.max(0,L*H-O)*C;
    case 'custom': return nn(it.manualQty||0)*C;
    default: return 0;
  }
}

function collect(){
  const type=CATALOG.find(t=>t.id===$('workType').value);
  const it={
    createdAt:new Date().toISOString(),
    objectName:$('objectName').value.trim(),
    workTypeId:type.id, workTypeName:type.name, unit:type.unit,
    length:$('f_length')?$('f_length').value:0,
    width:$('f_width')?$('f_width').value:0,
    height:$('f_height')?$('f_height').value:0,
    thickness:$('f_thickness')?$('f_thickness').value:0,
    diameter:$('f_diameter')?$('f_diameter').value:0,
    openings:$('f_openings')?$('f_openings').value:0,
    count:$('f_count')?$('f_count').value:1,
    manualQty:$('f_manualQty')?$('f_manualQty').value:0,
    manualUnitText:$('f_manualUnit')?$('f_manualUnit').value:'',
    thicknessMode:$('f_thicknessMode')?$('f_thicknessMode').value:null,
    brickType:$('f_brickType')?$('f_brickType').value:null,
    overrideOn:$('overrideToggle').checked,
    overrideQty:$('overrideQty').value,
    overrideUnit:$('overrideUnit').value,
    unitPrice:nn($('unitPrice').value),
    note:$('note').value.trim()
  };
  if(it.workTypeId==='masonry_wall' && it.thicknessMode){
    const th=THICKNESS.find(t=>t.id===it.thicknessMode); if(th) it.thickness=th.value;
  }
  it.qty = it.overrideOn ? nn(it.overrideQty) : qtyByFormula(it);
  it.displayUnit = it.overrideOn ? it.overrideUnit : (it.workTypeId==='custom' ? (it.manualUnitText||'ед.') : type.unit);

  // brick estimate
  it.brickEstimate=null;
  if(it.workTypeId==='masonry_wall'){
    const area = Math.max(0, nn(it.length)*nn(it.height)-nn(it.openings)) * Math.max(1,int(it.count)||1);
    const bt = BRICK_TYPES.find(b=>b.id===it.brickType) || BRICK_TYPES[0];
    const k=1.05;
    if(bt.faceArea>0){ it.brickEstimate = Math.ceil(area / bt.faceArea * k); }
  }
  it.lineTotal = it.qty * it.unitPrice;
  return it;
}

function recalcPreview(){
  const it=collect();
  $('qtyPreview').textContent=(it.qty||0).toFixed(3);
  $('unitLabel').textContent=unitText(it.displayUnit,it.manualUnitText);
  $('sumPreview').textContent=(it.lineTotal||0).toFixed(2);
  $('brickPreview').textContent=(it.workTypeId==='masonry_wall'&&it.brickEstimate)?(it.brickEstimate+' шт'):'—';
}

function bindFieldListeners(){
  const inputs=document.querySelectorAll('#fields input,#fields select');
  inputs.forEach(el=>{el.addEventListener('input',recalcPreview); el.addEventListener('change',recalcPreview);});
  $('overrideToggle').addEventListener('change',()=>{const on=$('overrideToggle').checked;$('overrideQty').disabled=!on;$('overrideUnit').disabled=!on;recalcPreview();});
  $('overrideQty').addEventListener('input',recalcPreview);
  $('overrideUnit').addEventListener('change',recalcPreview);
}

let state={rows:[]}; const LS='bek_rows_unlimited_full_v1';
function save(){localStorage.setItem(LS,JSON.stringify(state.rows))}
function load(){try{state.rows=JSON.parse(localStorage.getItem(LS)||'[]')}catch(e){state.rows=[]}}

function addRow(){
  const it=collect(); if(it.workTypeId==='masonry_wall' && it.brickEstimate){ it.note=(it.note?it.note+' | ':'')+`~${it.brickEstimate} шт (оценка)`;}
  state.rows.unshift(it); save(); renderRows();
}
function renderRows(){
  const tbody=document.querySelector('#rowsTable tbody'); tbody.innerHTML=''; let grand=0;
  state.rows.forEach(it=>{ grand+=it.lineTotal||0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(it.createdAt).toLocaleString('ru-RU')}</td><td>${esc(it.objectName)}</td><td>${esc(it.workTypeName)}</td><td>${unitText(it.displayUnit,it.manualUnitText)}</td><td class="right">${(it.qty||0).toFixed(3)}</td><td class="right">${(it.unitPrice||0).toFixed(2)}</td><td class="right">${(it.lineTotal||0).toFixed(2)}</td><td>${esc(it.note||'')}</td>`;
    tbody.appendChild(tr);
  });
  $('grandTotal').textContent=grand.toFixed(2);
}
function exportExcel(){
  const headers=['Дата/время','Объект','Вид работ','Ед. изм.','Кол-во','Цена','Сумма','Примечание'];
  const xmlCell=(v,t)=>{t=t||(typeof v==='number'?'Number':'String'); const s=(v??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); return `<Cell><Data ss:Type="${t}">${s}</Data></Cell>`;}
  let rowsXml='<Row>'+headers.map(h=>`<Cell ss:StyleID="sHdr"><Data ss:Type="String">${h}</Data></Cell>`).join('')+'</Row>';
  state.rows.forEach(it=>{rowsXml+='<Row>'+xmlCell(new Date(it.createdAt).toLocaleString('ru-RU'))+xmlCell(it.objectName||'')+xmlCell(it.workTypeName||'')+xmlCell(unitText(it.displayUnit,it.manualUnitText))+xmlCell(Number((it.qty||0).toFixed(3)),'Number')+xmlCell(Number((it.unitPrice||0).toFixed(2)),'Number')+xmlCell(Number((it.lineTotal||0).toFixed(2)),'Number')+xmlCell(it.note||'')+'</Row>'});
  const grand=state.rows.reduce((s,it)=>s+(it.lineTotal||0),0);
  rowsXml+='<Row></Row><Row>'+xmlCell('ИТОГО')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell('')+xmlCell(Number(grand.toFixed(2)),'Number')+'</Row>';
  const workbook=`<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Styles><Style ss:ID="sHdr"><Font ss:Bold="1"/><Interior ss:Color="#EAF1FF" ss:Pattern="Solid"/></Style></Styles><Worksheet ss:Name="BekCalc"><Table>${rowsXml}</Table></Worksheet></Workbook>`;
  const blob=new Blob([workbook],{type:'application/vnd.ms-excel'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bekcalc_export.xls'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function init(){
  populateWorkTypes(); renderFields(); load(); renderRows();
  $('objectName').addEventListener('input',recalcPreview);
  $('unitPrice').addEventListener('input',recalcPreview);
  $('note').addEventListener('input',recalcPreview);
  $('workType').addEventListener('change',renderFields);
  $('addBtn').addEventListener('click',addRow);
  $('resetBtn').addEventListener('click',()=>{document.querySelectorAll('#newItem input').forEach(i=>i.value='');$('overrideToggle').checked=false;$('overrideQty').disabled=true;$('overrideUnit').disabled=true;recalcPreview();});
  $('exportXlsBtn').addEventListener('click',exportExcel);
  recalcPreview();
}
document.addEventListener('DOMContentLoaded',init);
</script>
</body></html>
